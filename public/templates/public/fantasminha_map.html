{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasminha UFRRJ Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #map { height: 500px; width: 100%; border: 1px solid #ccc; margin-top: 20px; }
        .bus-title { font-size: 1.2em; margin-top: 10px; }
        button { padding: 10px 15px; font-size: 1em; cursor: pointer; }
        #statusMessage { margin-top: 15px; font-style: italic; }
    </style>
</head>
<body>
    <h1>Localizador Fantasminha UFRRJ</h1>

    <button id="toggleLocationBtn">Ativar Compartilhamento de Localização</button>
    <p id="userLocationStatus">Compartilhamento desativado.</p>

    <div id="busInfo">
        <h2>Posições Atuais do Fantasminha:</h2>
        <p id="statusMessage">Carregando...</p>
        <div id="busTitlesContainer">
            </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <script>
        // Get or generate a unique device ID
        let deviceId = localStorage.getItem('fantasminhaDeviceId');
        if (!deviceId) {
            deviceId = 'device-' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('fantasminhaDeviceId', deviceId);
        }
        console.log("Device ID:", deviceId);

        const toggleLocationBtn = document.getElementById('toggleLocationBtn');
        const userLocationStatus = document.getElementById('userLocationStatus');
        const statusMessageEl = document.getElementById('statusMessage');
        const busTitlesContainer = document.getElementById('busTitlesContainer');

        let isSharingLocation = false;
        let watchId = null;
        const UPDATE_LOCATION_URL = "{% url 'public:api_update_location' %}"; // Django URL reverse
        const GET_BUS_LOCATIONS_URL = "{% url 'public:api_get_fantasminha_locations' %}";

        // --- Map Initialization ---
        // Centered roughly on UFRRJ main campus
        const map = L.map('map').setView([-22.759, -43.688], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        let busMarkers = {}; // To store L.marker objects {bus_id: marker}

        // --- Location Sharing Logic ---
        toggleLocationBtn.addEventListener('click', () => {
            isSharingLocation = !isSharingLocation;
            if (isSharingLocation) {
                toggleLocationBtn.textContent = 'Desativar Compartilhamento';
                userLocationStatus.textContent = 'Compartilhamento ativo. Obtendo localização...';
                startWatchingLocation();
            } else {
                toggleLocationBtn.textContent = 'Ativar Compartilhamento';
                userLocationStatus.textContent = 'Compartilhamento desativado.';
                stopWatchingLocation();
            }
        });

        function startWatchingLocation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    sendLocationToServer,
                    handleLocationError,
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0, frequency: 5000 } // Update every 5s
                );
            } else {
                userLocationStatus.textContent = "Geolocalização não é suportada por este navegador.";
                isSharingLocation = false;
                toggleLocationBtn.textContent = 'Ativar Compartilhamento';
            }
        }

        function stopWatchingLocation() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        function sendLocationToServer(position) {
            const { latitude, longitude } = position.coords;
            userLocationStatus.textContent = `Localização: Lat ${latitude.toFixed(4)}, Lon ${longitude.toFixed(4)}`;

            fetch(UPDATE_LOCATION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Django's CSRF token would be needed if not @csrf_exempt
                    // 'X-CSRFToken': '{{ csrf_token }}' // If using Django templating for CSRF
                },
                body: JSON.stringify({ latitude, longitude, deviceId })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status !== 'success') console.error("Error updating location:", data.message);
                else console.log("Location sent successfully");
            })
            .catch(error => console.error('Error sending location:', error));
        }

        function handleLocationError(error) {
            let message = "Erro ao obter localização: ";
            switch(error.code) {
                case error.PERMISSION_DENIED: message += "Permissão negada."; break;
                case error.POSITION_UNAVAILABLE: message += "Informação de localização indisponível."; break;
                case error.TIMEOUT: message += "Tempo esgotado ao obter localização."; break;
                default: message += "Erro desconhecido."; break;
            }
            userLocationStatus.textContent = message;
            console.error(message, error);
            stopWatchingLocation(); // Stop trying if there's an error
            isSharingLocation = false;
            toggleLocationBtn.textContent = 'Ativar Compartilhamento';
        }

        // --- Fetching and Displaying Bus Locations ---
        function fetchBusLocations() {
            fetch(GET_BUS_LOCATIONS_URL)
            .then(response => response.json())
            .then(data => {
                statusMessageEl.textContent = data.status_message;
                busTitlesContainer.innerHTML = ''; // Clear previous titles

                // Clear old markers from map
                for (const id in busMarkers) {
                    map.removeLayer(busMarkers[id]);
                    delete busMarkers[id];
                }

                if (data.bus_details && data.bus_details.length > 0) {
                    data.bus_details.forEach(bus => {
                        const titleEl = document.createElement('p');
                        titleEl.classList.add('bus-title');
                        titleEl.textContent = bus.title;
                        busTitlesContainer.appendChild(titleEl);

                        // Add/Update marker on map
                        const busLatLng = [bus.latitude, bus.longitude];
                        busMarkers[bus.id] = L.marker(busLatLng)
                                              .addTo(map)
                                              .bindPopup(`<b>${bus.nearest_stop_name || 'Fantasminha'}</b><br>Posição estimada.`);
                    });
                } else {
                     // Handled by status_message, but could add more specific message here
                }
            })
            .catch(error => {
                console.error('Error fetching bus locations:', error);
                statusMessageEl.textContent = "Erro ao carregar localizações dos ônibus.";
            });
        }

        // Initial fetch and periodic updates for bus locations
        fetchBusLocations();
        setInterval(fetchBusLocations, 7000); // Fetch every 7 seconds for example
    </script>
</body>
</html>